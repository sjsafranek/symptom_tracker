{% extends "base.html" %}

{% block title %}WPSP :: Profile{% endblock %}



{% block stylesheet %}

<script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>

<style>
  
  main {
    padding-top: 80px;
  }

/*  .username h1 {
    text-transform: capitalize; 
  }

  .avatar {
    height: 200px !important;
    width: auto;
  }

  .error {
    color: red;
    font-size: small;
  }

  .user-card {
    cursor: pointer;
  }

  .user-card:hover {
    background: #e1e1e1;
    border-top: 1px solid #d0d0d0;
}
*/


  .dot, .circle {
    height: 15px; /* Or any desired size */
    width: 15px;  /* Must match height for a perfect circle */
    background-color: #bbb; /* Or any desired color */
    border-radius: 50%; /* This is key for creating a circle */
    display: inline-block; /* Allows elements to sit side-by-side */
  }

  .circle {
    background-color: transparent; /* Makes it a hollow circle */
    border: 2px solid #bbb; /* Adds a border for visibility */
  }

  .progress {
    border-radius: 0px;
  }

  td {
    vertical-align: middle;
  }

  .btn-protocol {
    --bs-btn-padding-y: .25rem; 
    --bs-btn-padding-x: .5rem; 
    --bs-btn-font-size: .75rem;
  }

</style>
{% endblock %}



{% block header %}

  {% include "navbar.html" %}    

{% endblock %}



{% block content %}

<div class="row mt-4">

  <div class="row mt-4">
    <div class="col-4">
      <strong>Therapist</strong>
      <select class="form-select" aria-label="Select a Therapist" id="therapist">
        <option selected disabled>Select a Therapist</option>
        {% for therapist in therapists %}
        <option value="{{ therapist.id }}">{{ therapist.user.get_full_name }}</option>
        {% endfor %}
      </select>
    </div>   
  </div>
  
  <div class="row mt-4">
    <div class="col-4">
      <strong>Client</strong>
      <select class="form-select" aria-label="Select a Client" id="client" disabled style="display:none;">
        <option selected disabled>Select a Client</option>
        {% for client in client %}
        <option value="{{ client.id }}">{{ client.user.get_full_name }}</option>
        {% endfor %}
      </select>
    </div> 
  </div>



  <div class="row mt-4">
    
    <div class="col-12" id="tracking-container">
      <table id="tracking" class="table table-striped table-bordered table-sm">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="" id="protocol-container">
    </div>

  </div>


</div>

{% endblock %}



{% block footer %}
<script>


  const Api = {
    fetchClientsByTherapist: function(therapist_id) {
      return fetch(`/api/v1/therapist/${therapist_id}/clients`)
        .then(response => response.json())
        .then(data => data.data.clients);
    },
    fetchSessionsByClient: function(client_id) {
      return fetch(`api/v1/client/${client_id}/sessions`)
        .then(response => response.json())
        .then(data => data.data.sessions);        
    },
    fetchSymptomsByClient: function(client_id) {
      return fetch(`api/v1/client/${client_id}/symptoms`)
        .then(response => response.json())
        .then(data => data.data.symptoms);
    },
    fetchSessionProtocol: function(session_id) {
      return fetch(`api/v1/session/${session_id}/protocol`)
        .then(response => response.json())
        .then(data => data.data.protocol);
    }
  }



  const UI = {

    elements: {
      $trackingContainer: $('#tracking-container'),
      $protocolContainer: $('#protocol-container')
    },

    colorScale: d3.scaleLinear()
      .domain([0, 10]) // Input data range
      .range(["blue", "red"]), // Output color range

    renderSessionProtocol: function(event) {
      let session_id = $(this).data()['sessionId'];
      Api.fetchSessionProtocol(session_id)
        .then((protocol) => {
          UI.elements.$trackingContainer.removeClass('col-12').addClass('col-9');
          UI.elements.$protocolContainer.addClass('col-3').empty();
          UI.elements.$protocolContainer.append(
            protocol.map(d => {
              return $('<div>').addClass('card mt-3').append(
                $('<div>').addClass('card-body').append(
                  $('<h5>').addClass('card-title').append(d.site),
                  $('<h6>').addClass('card-subtitle mb-2 text-body-secondary').append(d.type),
                  $('<div>').append(d.duration + ' minutes'),
                  ...d.settings.map(i => {
                    let type = i.type ?? '';
                    return $('<div>').append(type + ' ' + i.frequency + ' ' + i.unit);
                  })
                )
              );
            })
          );
        });
    },

    formatScore: function(score) {
      if (score) {
        let percentage = (score/10)*100;
        return $(`
        <div class="progress" role="progressbar" aria-label="Basic example" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
          <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: ${percentage}%; background-color: ${UI.colorScale(score)}">${score}</div>
        </div>`);
      }

      // let elements = [];
      // for (let i=1; i<11; i++) {
      //   if (i != score) {
      //     elements.push($('<span class="circle"></span>'));
      //     continue;
      //   }
      //   elements.push($('<span class="dot"></span>'));
      // }
      // return elements;
    }

  }



  document.addEventListener('DOMContentLoaded', () => {

    let $therapistSelector = $("#therapist");
    let $clientSelector = $("#client");


    $therapistSelector.on('change', (event) => {

      let therapist_id = $therapistSelector.val();

      Api.fetchClientsByTherapist(therapist_id)
        .then(clients => {
          $clientSelector
            .attr('disabled', false)
            .show()
            .empty()
            .append('<option selected disabled>Select a Client</option>')
            .append(
              clients.map(client => {
                return $('<option>', {value:client.id}).append(client.name);
              })
            );
        });

    });


    $clientSelector.on('change', (event) => {

      let client_id = $clientSelector.val();

      Promise.all([
        Api.fetchSymptomsByClient(client_id),
        Api.fetchSessionsByClient(client_id)
      ])
      .then((results) => {

        let dataTable = new DataTable('#tracking');
        dataTable.destroy();

        let dataset = {
          symptoms: {},
          baselines: {
            'good': {
              number: null,
              date: 'Baseline: Good Week',
              scores: {}
            },
            'bad': {
              number: null,
              date: 'Baseline: Bad Week',
              scores: {}
            },
            'usual': {
              number: null,
              date: 'Baseline: Usual Week',
              scores: {}
            }
          },
          sessions: {}
        };
        
        let symptoms = results[0];
        for (let i=0; i<symptoms.length; i++) {
          let symptom = symptoms[i];
          dataset.symptoms[symptom.name] = symptom.is_active;
          dataset.baselines.good.scores[symptom.name] = symptom.baseline.goodweek;
          dataset.baselines.bad.scores[symptom.name] = symptom.baseline.badweek;
          dataset.baselines.usual.scores[symptom.name] = symptom.baseline.usualweek;
        }


        let sessions = results[1];
        for (let i=0; i<sessions.length; i++) {
          let session = sessions[i];
          if (session.no_show) continue;

          dataset.sessions[session.date] = {
            id: session.id,
            date: session.date,
            number: session.number,
            scores: {}
          }

          for (let j=0; j<session.symptom_scores.length; j++) {
            let symptom = session.symptom_scores[j];
            dataset.sessions[session.date].scores[symptom.name] = symptom.score;
          }
        } 

        let _symptoms = Object.keys(dataset.symptoms);
        $columns = $('<tr>').append(
          $('<th>').append('date'),
          $('<th>').addClass('text-center').append('number'),
          ..._symptoms.map(d => {
            return $('<th>').append(d)
          }),
          $('<th>').addClass('text-center').append('protocol')
        );

        $('#tracking').empty()
          .append(
            $('<thead>').append($columns.clone()),
            $('<tbody>').append(
              (function() {
                let rows = [];

                rows.push(
                  $('<tr>').append(
                    $('<td>').append('Good Week'),
                    $('<td>').append(''),
                    ..._symptoms.map(d => {
                      let icon = UI.formatScore(dataset.baselines.good.scores[d]);
                      return $('<td>').append(icon);
                    }),
                    $('<td>').append('')
                  )
                );

                rows.push(
                  $('<tr>').append(
                    $('<td>').append('Bad Week'),
                    $('<td>').append(''),
                    ..._symptoms.map(d => {
                      let icon = UI.formatScore(dataset.baselines.bad.scores[d]);
                      return $('<td>').append(icon);
                    }),
                    $('<td>').append('')
                  )
                );

                rows.push(
                  $('<tr>').append(
                    $('<td>').append('Usual Week'),
                    $('<td>').append(''),
                    ..._symptoms.map(d => {
                      let icon = UI.formatScore(dataset.baselines.usual.scores[d]);
                      return $('<td>').append(icon);
                    }),
                    $('<td>').append('')
                  )
                );

                for (let date in dataset.sessions) {
                  rows.push(
                    $('<tr>').append(
                      $('<td>').append(date),
                      $('<td>').addClass('text-center').append(dataset.sessions[date].number),
                      ..._symptoms.map(d => {
                        let icon = UI.formatScore(dataset.sessions[date].scores[d]);
                        return $('<td>').append(icon);
                      }),
                      $('<td>').addClass('text-center').append(
                        $('<button>')
                          .addClass('btn btn-sm btn-info btn-protocol')
                          .data('session-id', dataset.sessions[date].id)
                          .append('Protocol')
                          .on('click', UI.renderSessionProtocol)
                      )
                    )
                  );
                }

                return rows;
              })()
            ),
            $('<tfoot>').append($columns.clone())
          );


          dataTable = new DataTable('#tracking', {
            ordering: false,
            paging: false,
            searching: false
          });

      });

    });

  }, false);

</script>
{% endblock %}